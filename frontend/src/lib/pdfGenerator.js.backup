import { format } from 'date-fns';
import { ar } from 'date-fns/locale';
import { formatDate } from '$lib/utils';
import { config } from '$lib/config';
import { get } from 'svelte/store';
import { token } from '$lib/stores';

// Generate HTML content for the document
function generateHTMLContent(data) {
  return `
    <!DOCTYPE html>
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Ø¥Ø­Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ø± ØªØ¬Ø§Ø±ÙŠØ©</title>
      <style>
        @font-face {
          font-family: 'Amiri';
          src: url('/Amiri-Regular.ttf') format('truetype');
          font-weight: normal;
          font-style: normal;
        }
        @font-face {
          font-family: 'Amiri';
          src: url('/fonts/Amiri-Bold.ttf') format('truetype');
          font-weight: bold;
          font-style: normal;
        }
        @font-face {
          font-family: 'Amiri';
          src: url('/Amiri-Italic.ttf') format('truetype');
          font-weight: normal;
          font-style: italic;
        }
        @font-face {
          font-family: 'Amiri';
          src: url('/Amiri-BoldItalic.ttf') format('truetype');
          font-weight: bold;
          font-style: italic;
        }
        
        body {
          font-family: 'Amiri', Arial, sans-serif;
          font-size: 14px;
          line-height: 1.6;
          margin: 40px;
          direction: rtl;
          text-align: right;
          unicode-bidi: bidi-override;
        }
        
        .header {
          font-size: 18px;
          font-weight: bold;
          text-align: center;
          margin-bottom: 20px;
          direction: rtl;
          unicode-bidi: bidi-override;
        }
        
        .subheader {
          font-size: 14px;
          font-weight: bold;
          text-align: center;
          margin-bottom: 20px;
          direction: rtl;
          unicode-bidi: bidi-override;
        }
        
        .section-header {
          font-size: 14px;
          font-weight: bold;
          margin: 20px 0 10px 0;
          direction: rtl;
          text-align: right;
          unicode-bidi: bidi-override;
        }
        
        .field {
          margin-bottom: 8px;
          direction: rtl;
          text-align: right;
          unicode-bidi: bidi-override;
        }
        
        .field-label {
          font-weight: bold;
          display: inline;
          direction: rtl;
          unicode-bidi: bidi-override;
        }
        
        .field-value {
          display: inline;
          direction: rtl;
          unicode-bidi: bidi-override;
        }
        
        .signature-section {
          display: flex;
          justify-content: space-between;
          margin-top: 40px;
          text-align: center;
          direction: rtl;
        }
        
        .signature-box {
          width: 30%;
          text-align: center;
          direction: rtl;
          unicode-bidi: bidi-override;
        }
        
        .court-signature {
          text-align: center;
          margin-top: 20px;
          direction: rtl;
          unicode-bidi: bidi-override;
        }
        
        .agreement-text {
          margin: 20px 0;
          line-height: 1.8;
          direction: rtl;
          text-align: right;
          unicode-bidi: bidi-override;
        }
        
        @media print {
          body {
            margin: 0;
            padding: 20px;
          }
        }
      </style>
    </head>
    <body>
      <div class="header">Ø¥Ø­Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ø± ØªØ¬Ø§Ø±ÙŠØ©</div>
      <div class="subheader">(ÙÙŠ Ø¥Ø·Ø§Ø± Ù‚Ø§Ù†ÙˆÙ† Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„ØªÙ‚Ø³ÙŠØ·)</div>
      
      <div class="section-header">Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙƒÙ…Ø©:</div>
      <div class="field">
        <span class="field-label">Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ù†Ø§Ø­ÙŠØ©: </span>
        <span class="field-value">${data.courtName || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ø¯ÙØªØ±: </span>
        <span class="field-value">${data.bookNumber || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„ØµÙØ­Ø©: </span>
        <span class="field-value">${data.pageNumber || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®: </span>
        <span class="field-value">${data.date || '_________________'}</span>
      </div>
      
      <div class="section-header">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…Ø²ÙˆØ¯:</div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¨Ø§Ø¦ÙŠ: </span>
        <span class="field-value">${data.supplierTaxId || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø²ÙˆØ¯: </span>
        <span class="field-value">${data.supplierName || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: </span>
        <span class="field-value">${data.supplierAddress || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ù„Ù„Ù…Ø²ÙˆØ¯: </span>
        <span class="field-value">${data.supplierBankAccount || '_________________'}</span>
      </div>
      
      <div class="section-header">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø¹ÙˆÙ† Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠ:</div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ­ÙŠØ¯: </span>
        <span class="field-value">${data.workerNumber || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ø¥Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨: </span>
        <span class="field-value">${data.fullName || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ·Ù†ÙŠØ©: </span>
        <span class="field-value">${data.cin || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø®ØµÙŠ: </span>
        <span class="field-value">${data.address || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø§Ù„Ù…Ù†ØªÙ…ÙŠ Ø§Ù„ÙŠÙ‡: </span>
        <span class="field-value">${data.workplace || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ø±ØªØ¨Ø©: </span>
        <span class="field-value">${data.jobTitle || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©: </span>
        <span class="field-value">Ù…Ø¨Ø§Ø´Ø±</span>
      </div>
      <div class="field">
        <span class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ: </span>
        <span class="field-value">${data.bankAccountNumber || '_________________'}</span>
      </div>
      
      <div class="section-header">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ù‚ØªÙ†Ø§Ø©:</div>
      <div class="field">
        <span class="field-label">Ø°ÙƒØ± Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ù‚ØªÙ†Ø§Ø© Ø¨ÙƒÙ„ Ø¯Ù‚Ø©: </span>
        <span class="field-value">${data.itemDescription || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ù…Ù„ÙŠ Ù„Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ù‚ØªÙ†Ø§Ø© Ø¨Ù„Ø³Ø§Ù† Ø§Ù„Ù‚Ù„Ù…: </span>
        <span class="field-value">${data.amountInWords || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ù…Ù„ÙŠ Ù„Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ù‚ØªÙ†Ø§Ø© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: </span>
        <span class="field-value">${data.totalAmountNumeric || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…Ù‚ØªØ·Ø¹ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: </span>
        <span class="field-value">${data.monthlyPayment || '_________________'}</span>
      </div>
      <div class="field">
        <span class="field-label">Ù…Ø¯Ø© Ø§Ù„Ø§Ù‚ØªØ·Ø§Ø¹ Ù…Ù† Ø§Ù„Ø£Ø¬Ø±: </span>
        <span class="field-value">18 Ø´Ù‡Ø±Ø§</span>
      </div>
      <div class="field">
        <span class="field-label">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø³Ø±ÙŠØ§Ù† Ø£ÙˆÙ„ Ø§Ù‚ØªØ·Ø§Ø¹ Ù…Ù† Ø§Ù„Ø£Ø¬Ø±: </span>
        <span class="field-value">${data.firstDeductionMonthArabic || '_________________'}</span>
      </div>
      
      <div class="section-header">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø§ØªÙØ§Ù‚:</div>
      <div class="agreement-text">
        Ø¨Ù…Ù‚ØªØ¶Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ÙŠØ£Ø°Ù† Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ø£Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„Ø¯Ù‰ ${data.workplace || '_________________'} Ø§Ù„Ø§Ù‚ØªØ·Ø§Ø¹ Ø´Ù‡Ø±ÙŠØ§ Ù…Ù† Ø±Ø§ØªØ¨Ù‡ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø°ÙƒÙˆØ± Ø£Ø¹Ù„Ø§Ù‡ Ùˆ ØªØ­ÙˆÙŠÙ„Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù„Ù…Ø²ÙˆØ¯ ${data.supplierName || '_________________'} Ø­ØªÙ‰ Ø§Ù„Ø®Ù„Ø§Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ø§ Ù„Ù… ØªØ·Ø±Ø£ Ù…ÙˆØ§Ù†Ø¹ Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø£Ùˆ Ù…Ù‡Ù†ÙŠØ© Ø£Ùˆ ØºÙŠØ±Ù‡Ø§ ØªØ­ÙˆÙ„ Ø¯ÙˆÙ† Ø°Ù„Ùƒ.
      </div>
      
      <div class="signature-section">
        <div class="signature-box">Ø§Ù…Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø²ÙˆØ¯ ÙˆØ®ØªÙ…Ù‡</div>
        <div class="signature-box">Ø§Ù…Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙ†</div>
        <div class="signature-box">Ø®ØªÙ… Ø§Ù„Ù…Ø¤Ø¬Ø±</div>
      </div>
      
      <div class="court-signature">Ø®ØªÙ… Ø§Ù„Ù…Ø­ÙƒÙ…Ø© Ùˆ Ø§Ù„Ø¥Ù…Ø¶Ø§Ø¡</div>
    </body>
    </html>
  `;
}

// Convert HTML to PDF using browser's print functionality
async function htmlToPdf(htmlContent) {
  // Create a new window with the HTML content
  const printWindow = window.open('', '_blank');
  printWindow.document.write(htmlContent);
  printWindow.document.close();
  
  // Wait for fonts to load
  await new Promise(resolve => {
    printWindow.addEventListener('load', () => {
      setTimeout(resolve, 1000); // Give extra time for font loading
    });
  });
  
  // Trigger print dialog
  printWindow.print();
  
  // Close the window after printing
  setTimeout(() => {
    printWindow.close();
  }, 1000);
}

// Use backend PDF generation for better quality
export async function openPDF(data) {
  try {
    // Prevent any accidental navigation of the current page
    const originalLocation = window.location.href;
    
    console.log('Attempting backend PDF generation with data:', data);
    
    // Validate required data
    if (!data.fullName && !data.workerNumber) {
      throw new Error('Missing essential data for PDF generation');
    }
    
    // Get authentication token if available
    const authToken = get(token);
    const headers = {
      'Content-Type': 'application/json',
    };
    
    if (authToken) {
      headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    const response = await fetch(`${config.backendUrl}/api/v1/documents/salary-assignment`, {
      method: 'POST',
      headers,
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('Backend PDF generation failed:', response.status, response.statusText, errorText);
      
      // If backend fails, fall back to HTML method
      console.log('Falling back to HTML PDF generation');
      const htmlContent = generateHTMLContent(data);
      return openHTMLInBrowser(htmlContent);
    }
    
    // Get the PDF blob
    const pdfBlob = await response.blob();
    console.log('PDF generated successfully, size:', pdfBlob.size, 'bytes');
    
    // Create a URL for the blob
    const pdfUrl = URL.createObjectURL(pdfBlob);
    
    // Safety check: ensure we're still on the original page
    if (window.location.href !== originalLocation) {
      console.warn('Page navigation detected, restoring original location');
      window.location.href = originalLocation;
      return;
    }
    
    // Attempt 1: Try to open PDF in a new application page/tab
    await openPDFInNewPage(pdfUrl, data);
    
    // Clean up the URL after a delay to allow the browser to load it
    setTimeout(() => {
      URL.revokeObjectURL(pdfUrl);
    }, 10000);
    
  } catch (error) {
    console.error('Error in PDF generation:', error);
    // Fallback to HTML method
    console.log('Using HTML fallback method');
    const htmlContent = generateHTMLContent(data);
    openHTMLInBrowser(htmlContent);
  }
}

// Function to open PDF in a new page of the application or external browser
async function openPDFInNewPage(pdfUrl, data) {
  try {
    // First attempt: Open in a new tab/page with better browser detection
    let newWindow = null;
    
    // Try to open in the default browser first
    newWindow = window.open('about:blank', '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes,menubar=yes,toolbar=yes,location=yes,status=yes');
    
    // Check if the new window was opened successfully
    if (newWindow && !newWindow.closed) {
      // Wait for the window to be ready
      setTimeout(() => {
        try {
          // Create a full PDF viewer page
          newWindow.document.write(`
            <!DOCTYPE html>
            <html dir="rtl" lang="ar">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Ø¥Ø­Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ø± ØªØ¬Ø§Ø±ÙŠØ© - ${data.fullName || 'ÙˆØ«ÙŠÙ‚Ø©'}</title>
          <style>
            body { 
              margin: 0; 
              padding: 0; 
              background: #f5f5f5;
              font-family: Arial, sans-serif;
            }
            .header {
              background: #2563eb;
              color: white;
              padding: 15px 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .header h1 {
              margin: 0;
              font-size: 18px;
              font-weight: 600;
            }
            .header .actions {
              display: flex;
              gap: 10px;
            }
            .header button {
              background: rgba(255,255,255,0.2);
              border: 1px solid rgba(255,255,255,0.3);
              color: white;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              transition: background 0.2s;
            }
            .header button:hover {
              background: rgba(255,255,255,0.3);
            }
            .pdf-container {
              width: 100%;
              height: calc(100vh - 70px);
              border: none;
              background: white;
            }
            .fallback {
              text-align: center;
              padding: 40px 20px;
              color: #666;
            }
            .fallback a {
              color: #2563eb;
              text-decoration: none;
              font-weight: 600;
            }
            .fallback a:hover {
              text-decoration: underline;
            }
            .browser-links {
              margin-top: 20px;
              display: flex;
              justify-content: center;
              gap: 15px;
              flex-wrap: wrap;
            }
            .browser-link {
              background: #f8f9fa;
              border: 1px solid #dee2e6;
              padding: 12px 20px;
              border-radius: 8px;
              text-decoration: none;
              color: #495057;
              font-weight: 500;
              transition: all 0.2s;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .browser-link:hover {
              background: #e9ecef;
              border-color: #adb5bd;
              transform: translateY(-1px);
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Ø¥Ø­Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ø± ØªØ¬Ø§Ø±ÙŠØ©</h1>
            <div class="actions">
              <button onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
              <button onclick="downloadPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„</button>
              <button onclick="window.close()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>
          
          <div id="pdf-viewer">
            <embed src="${pdfUrl}" type="application/pdf" class="pdf-container">
            <object data="${pdfUrl}" type="application/pdf" class="pdf-container">
              <iframe src="${pdfUrl}" class="pdf-container">
                <div class="fallback">
                  <h3>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù…Ù„Ù PDF Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
                  <p><a href="${pdfUrl}" target="_blank">Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„ÙØªØ­ Ù…Ù„Ù PDF</a></p>
                  <p>Ø£Ùˆ Ø¬Ø±Ø¨ ÙØªØ­Ù‡ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                  <div class="browser-links">
                    <a href="#" class="browser-link" onclick="openInEdge()">
                      ğŸŒ Microsoft Edge
                    </a>
                    <a href="#" class="browser-link" onclick="openInChrome()">
                      ğŸŒ Google Chrome
                    </a>
                    <a href="#" class="browser-link" onclick="openInFirefox()">
                      ğŸŒ Firefox
                    </a>
                  </div>
                </div>
              </iframe>
            </object>
          </embed>
          </div>
          
          <script>
            function downloadPDF() {
              const link = document.createElement('a');
              link.href = '${pdfUrl}';
              link.download = 'Ø¥Ø­Ø§Ù„Ø©_Ø±Ø§ØªØ¨_${data.fullName || 'ÙˆØ«ÙŠÙ‚Ø©'}_${new Date().toISOString().split('T')[0]}.pdf';
              link.click();
            }
            
            function openInEdge() {
              try {
                // Try to open in Microsoft Edge
                const edgeUrl = 'microsoft-edge:' + '${pdfUrl}';
                window.location.href = edgeUrl;
                setTimeout(() => {
                  // Fallback if Edge protocol doesn't work
                  window.open('${pdfUrl}', '_blank');
                }, 1000);
              } catch (e) {
                window.open('${pdfUrl}', '_blank');
              }
            }
            
            function openInChrome() {
              try {
                // Try to open in Google Chrome
                const chromeUrl = 'googlechrome://' + '${pdfUrl}';
                window.location.href = chromeUrl;
                setTimeout(() => {
                  // Fallback if Chrome protocol doesn't work
                  window.open('${pdfUrl}', '_blank');
                }, 1000);
              } catch (e) {
                window.open('${pdfUrl}', '_blank');
              }
            }
            
            function openInFirefox() {
              try {
                // Firefox doesn't have a special protocol, just open normally
                window.open('${pdfUrl}', '_blank');
              } catch (e) {
                console.error('Failed to open in Firefox:', e);
              }
            }
            
            // Auto-focus the new window
            window.focus();
          </script>
        </body>
        </html>
      `);
      newWindow.document.close();
      
      // Focus the new window
      newWindow.focus();
      
      console.log('PDF opened in new application page successfully');
      return;
    }
    
    throw new Error('Failed to open new window');
    
  } catch (error) {
    console.log('Failed to open in new page, trying external browser methods:', error.message);
    
    // Attempt 2: Try to open in external browsers directly
    await openInExternalBrowser(pdfUrl);
  }
}

// Function to open PDF in external browsers (Edge, Chrome, etc.)
async function openInExternalBrowser(pdfUrl) {
  try {
    // Try Microsoft Edge first
    try {
      const edgeUrl = `microsoft-edge:${pdfUrl}`;
      window.location.href = edgeUrl;
      console.log('Attempting to open in Microsoft Edge');
      return;
    } catch (edgeError) {
      console.log('Microsoft Edge protocol failed:', edgeError.message);
    }
    
    // Try Google Chrome
    try {
      const chromeUrl = `googlechrome://${pdfUrl}`;
      window.location.href = chromeUrl;
      console.log('Attempting to open in Google Chrome');
      return;
    } catch (chromeError) {
      console.log('Google Chrome protocol failed:', chromeError.message);
    }
    
    // Fallback: Open in default browser
    window.open(pdfUrl, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');
    console.log('Opened in default browser as fallback');
    
  } catch (error) {
    console.error('All browser methods failed:', error);
    // Show user message
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù…Ù„Ù PDF ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆÙØªØ­Ù‡ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­: ' + pdfUrl);
  }
}

// Function to open HTML content in browser when PDF generation fails
function openHTMLInBrowser(htmlContent) {
  try {
    // Create a new window with the HTML content
    const htmlWindow = window.open('about:blank', '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes,menubar=yes,toolbar=yes');
    
    if (htmlWindow && !htmlWindow.closed) {
      htmlWindow.document.write(htmlContent);
      htmlWindow.document.close();
      htmlWindow.focus();
      
      console.log('HTML document opened in new browser window');
    } else {
      throw new Error('Failed to open HTML window');
    }
  } catch (error) {
    console.error('Failed to open HTML in browser:', error);
    // Final fallback: show the HTML content in current page (not recommended but better than nothing)
    const newDiv = document.createElement('div');
    newDiv.innerHTML = htmlContent;
    newDiv.style.position = 'fixed';
    newDiv.style.top = '0';
    newDiv.style.left = '0';
    newDiv.style.width = '100%';
    newDiv.style.height = '100%';
    newDiv.style.backgroundColor = 'white';
    newDiv.style.zIndex = '9999';
    document.body.appendChild(newDiv);
  }
}

export async function downloadPDF(data, filename = 'salary_assignment_document.pdf') {
  try {
    console.log('Downloading PDF data from backend:', data);
    
    // Get authentication token if available
    const authToken = get(token);
    const headers = {
      'Content-Type': 'application/json',
    };
    
    if (authToken) {
      headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    const response = await fetch(`${config.backendUrl}/api/v1/documents/salary-assignment`, {
      method: 'POST',
      headers,
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      console.error('Backend PDF generation failed:', response.status, response.statusText);
      const errorText = await response.text();
      console.error('Error details:', errorText);
      
      // Fallback to HTML method
      const htmlContent = generateHTMLContent(data);
      return htmlToPdf(htmlContent);
    }
    
    // Get the PDF blob
    const pdfBlob = await response.blob();
    
    // Create a download link
    const link = document.createElement('a');
    const pdfUrl = URL.createObjectURL(pdfBlob);
    link.href = pdfUrl;
    link.download = filename;
    link.click();
    
    // Clean up
    URL.revokeObjectURL(pdfUrl);
    
  } catch (error) {
    console.error('Error downloading PDF from backend:', error);
    // Fallback to HTML method
    const htmlContent = generateHTMLContent(data);
    htmlToPdf(htmlContent);
  }
}